<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Motivation](#motivation)
- [Goals](#goals)
- [Non-Goals](#non-goals)
- [API](#api)
  - [Resulting AlluxioRuntime](#resulting-alluxioruntime)
  - [Resulting Alluxio Helm Chart](#resulting-alluxio-helm-chart)
- [Workflow](#workflow)
- [Alternatives Considered](#alternatives-considered)
- [Commits](#commits)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## Motivation
当使用HDFS作为Alluxio的UFS时, 如果HDFS使用**非默认**的配置,那么可能需要将该配置文件(e.g. `hdfs-site.xml`或`core-site.xml`)传递给Alluxio. Fluid目前不支持这样的配置方式, 因此拥有特殊配置的HDFS集群的用户将难以使用Fluid进行Alluxio分布式缓存引擎的部署.

## Goals
* 支持HDFS的特殊配置

## Non-Goals
* 暂时仅支持HDFS的特殊配置,不适用于其他Alluxio的底层存储集成

## API

### Resulting AlluxioRuntime

```yaml
apiVersion: data.fluid.io/v1alpha1
kind: AlluxioRuntime
metadata:
  name: hadoop
  namespace: default
spec:
  ...
  hadoopConfig:
    name: hdfs-configmap
    hdfsSiteKey: hdfs
    coreSiteKey: core
  ...
```


在AlluxioRuntime定义中添加`spec.hadoopConfig`属性, 该属性定义了`hdfs-site.xml`和`core-site.xml`两个HDFS相关配置文件的来源.该来源**必须**是一个用户预先创建好的ConfigMap. 用户可以通过`name`来指明所要引用的ConfigMap,并使用`hdfsSiteKey`和`coreSiteKey`来分别指明ConfigMap中的需要使用的键值对, 键值对对应的Value将会分别作为`hdfs-site.xml`和`core-site.xml`挂载进Alluxio的各个容器中. **该ConfigMap必须与AlluxioRuntime处于同一命名空间**

### Resulting Alluxio Helm Chart

`values.yaml`中增加如下内容:

```yaml
hadoopConfig:
  configMap: hdfs-configmap
  hdfsSiteKey: hdfs
  coreSiteKey: core
```

Alluxio Helm Chart模板(e.g. `master/statefulset.yaml`以及`worker/daemonset.yaml`)中增加与ConfigMap挂载相关的配置:

```yaml
containers:
  - name: xxx
    ...
    volumeMounts:
    ...
    - name: hdfs-config
      mountPath: "/hdfs-config"
      readOnly: true

volumes:
  ...
  - name: hdfs-config
    configMap:
      name: {{ .Values.hadoopConfig.configMap }}
      items:
      - key: {{ .Values.hadoopConfig.hdfsSiteKey }}
        path: "hdfs-site.xml"
      - key: {{ .Values.hadoopConfig.coreSiteKey }}
        path: "core-site.xml"
  ...
```

上述配置将在创建出的Alluxio Master以及Alluxio Worker Pod的各个容器中以ConfigMap挂载的方式创建 `/hdfs-config/hdfs-site.xml`以及`/hdfs-config/core-site.xml`. 

在Alluxio的容器中挂载用户定义的上述HDFS配置文件后,仅需设置`alluxio.underfs.hdfs.configuration=/hdfs-config/hdfs-site.xml:/hdfs-config/core-site.xml`即可启用Alluxio对HDFS特殊配置的支持


## Workflow

1. 用户根据本地的`hdfs-site.xml`以及`core-site.xml`创建ConfigMap

2. 用户创建AlluxioRuntime时引用该ConfigMap

3. `alluxioruntime-controller`检查是否需要HDFS的特殊配置,如果需要则额外设置 Alluxio Property `alluxio.underfs.hdfs.configuration`

4. `alluxioruntime-controller`生成helm chart所需的`values.yaml`,以该`values.yaml`进行 helm install

5. Alluxio集群启动时读取HDFS相关配置文件.

## Alternatives Considered

使用Secret而不是ConfigMap完成上述过程.

## Commits


