# metadata的保存和加载

## 目标
对每个Dataset，alluxioruntime会启动一套alluxio集群，并将UFS的metadata保存在master（目前仅1个）
希望用户可以将metadata保存成持久化文件，便于下一次启动alluxio集群时加载此文件以进行恢复。
需要考虑的设计点：
* 用户可能会将metadata持久化文件存储到外部存储（如分布式文件系统、NFS）中，也有可能只能保存在主机文件系统。
* 需要尽量简化用户操作。

## 保存
可以使用alluxio提供的[Admin Command Line Interface](https://docs.alluxio.io/os/user/stable/en/operation/Admin-CLI.html)进行保存。
metadata备份命令为alluxio fsadmin backup命令，备份位置可以是（待讨论）：
（1）under storage system
（2）the leading master's local filesystem

为用户提供一个job。用户需要保存时，启动此job，启动时只需：
（1）指定Namespace和Dataset名
（2）挂载保存位置（如pvc或localpath）

job需要挂载有pod/exec权限的ServiceAccount，去同Namespace下查找名为{$DatasetName}-master-0的pod，执行backup命令。

* 如果备份位置是under storage system，可以通过alluxio client将文件从alluxio中取出
* 如果备份位置是the leading master's local filesystem，可以使用容器间文件传输的方式（如kubectl cp命令）取出

取出后，保存到用户指定的位置。

## 加载
在alluxioruntime的spec中新增一个可选字段dataSource，该字段可以指定PVC，或者hostname+hostpath
需要修改alluxio的charts和相应代码：
* 如果metadata保存位置是pvc，则在alluxio-master中挂载此pvc
* 如果metadata保存位置是hostpath，则在alluxio-master中挂载此hostpath，并且还要为master直接指定nodeSelector

添加环境变量，让alluxio容器在启动时能够需要的文件。

```yaml
...
env:
  - name: "JOURNAL_BACKUP"
    value: "/my-journal/backup.gz"

...
```
